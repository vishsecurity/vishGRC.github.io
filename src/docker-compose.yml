version: '3.8'

services:
  grc-suite:
    image: grc-suite:latest
    container_name: grc-suite
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      # Persistent data storage
      - ./data:/app/data
      # Backup storage
      - ./backups:/app/backups
      # Application logs
      - ./logs:/app/logs
      # Configuration files
      - ./config:/app/config
      # Templates (optional, if you want to modify templates externally)
      - ./templates:/app/templates
    environment:
      # Application settings
      - NODE_ENV=production
      - PORT=8080
      
      # Database settings
      - DB_TYPE=sqlite
      - DB_PATH=/app/data/grc.db
      
      # Backup settings
      - BACKUP_ENABLED=true
      - BACKUP_SCHEDULE=0 2 * * *
      - BACKUP_RETENTION_DAYS=30
      
      # Security settings
      - SESSION_TIMEOUT=30
      - JWT_SECRET=${JWT_SECRET:-change-this-secret-key-in-production}
      
      # AI Integration (optional)
      - AI_PROVIDER=${AI_PROVIDER:-none}
      - AI_API_KEY=${AI_API_KEY:-}
      - AI_MODEL=${AI_MODEL:-gpt-4}
      - AI_ENDPOINT=${AI_ENDPOINT:-}
      
      # Email notifications (optional)
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASS=${SMTP_PASS:-}
      - SMTP_FROM=${SMTP_FROM:-noreply@grcsuite.local}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FILE=/app/logs/app.log
      
      # Timezone
      - TZ=${TZ:-UTC}
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    networks:
      - grc-network
    
    # Resource limits (adjust based on your needs)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (for security)
    # Uncomment if your app supports this
    # read_only: true
    
    # Temporary file storage
    tmpfs:
      - /tmp

networks:
  grc-network:
    driver: bridge

volumes:
  # Named volumes for better management (optional)
  # Uncomment to use named volumes instead of bind mounts
  # grc-data:
  # grc-backups:
  # grc-logs:
