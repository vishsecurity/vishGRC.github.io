<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TPRM Portal</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container py-4">

  <!-- LOGIN -->
  <div id="loginSection">
    <h2>Admin Login</h2>
    <input id="username" placeholder="Username" class="form-control mb-2">
    <input id="password" placeholder="Password" type="password" class="form-control mb-2">
    <button class="btn btn-primary mb-3" onclick="adminLogin()">Login</button>

    <h2>Vendor Login</h2>
    <input id="vendorEmail" placeholder="Email" class="form-control mb-2">
    <button class="btn btn-success" onclick="vendorLogin()">Login</button>
  </div>

  <button id="logoutBtn" class="btn btn-warning hidden mb-3">Logout</button>

  <!-- ADMIN DASHBOARD -->
  <div id="adminSection" class="hidden">
    <h3>Vendors (<span id="totalVendors">0</span>)</h3>
    <table class="table table-bordered" id="vendorsTable"></table>

    <h3>Responses (<span id="totalResponses">0</span>)</h3>
    <table class="table table-bordered" id="responsesTable"></table>
  </div>

  <!-- VENDOR SECTION -->
  <div id="vendorSection" class="hidden">
    <h3>Questions</h3>
    <div class="accordion" id="questionsContainer"></div>
  </div>
</div>

<script>
const API = "http://localhost:4000";
let token = localStorage.getItem("token");
let role = localStorage.getItem("role");
let userId = localStorage.getItem("userId");

// Auto-login
if (token && role) {
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  if(role==="admin") loadAdmin();
  if(role==="vendor") loadVendor();
}

// API helper
async function apiCall(url, options={}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      ...options.headers,
      ...(options.body instanceof FormData ? {} : {"Content-Type":"application/json"}),
      Authorization: `Bearer ${token}`
    }
  });
  if(res.status===401){ localStorage.clear(); location.reload(); throw new Error("Session expired"); }
  return res;
}

// LOGIN
async function adminLogin() {
  try{
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const res = await apiCall(`${API}/login`, {method:"POST", body: JSON.stringify({username,password})});
    const data = await res.json();
    if(res.ok) saveAuth(data); else alert(data.error || "Login failed");
  } catch(e){ alert("Network error"); }
}

async function vendorLogin() {
  try{
    const email = document.getElementById("vendorEmail").value;
    const res = await apiCall(`${API}/vendor-login`, {method:"POST", body: JSON.stringify({email})});
    const data = await res.json();
    if(res.ok) saveAuth(data); else alert(data.error || "Vendor login failed");
  } catch(e){ alert("Network error"); }
}

// Save auth
function saveAuth(data){
  token = data.token; role = data.role; userId = data.id;
  localStorage.setItem("token", token);
  localStorage.setItem("role", role);
  localStorage.setItem("userId", userId);
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("logoutBtn").classList.remove("hidden");
  if(role==="admin") loadAdmin();
  if(role==="vendor") loadVendor();
}

document.getElementById("logoutBtn").onclick = ()=>{ localStorage.clear(); location.reload(); };

// ADMIN
async function loadAdmin(){
  try{
    document.body.classList.add("loading");
    document.getElementById("adminSection").classList.remove("hidden");

    let v = await apiCall(`${API}/vendors`);
    let vendors = await v.json();
    document.getElementById("vendorsTable").innerHTML = buildVendorTable(vendors);
    document.getElementById("totalVendors").textContent = vendors.length;

    let r = await apiCall(`${API}/responses`);
    let responses = await r.json();
    document.getElementById("responsesTable").innerHTML = buildResponsesTable(responses);
    document.getElementById("totalResponses").textContent = responses.length;
  } catch(e){ alert("Failed to load data"); }
  finally{ document.body.classList.remove("loading"); }
}

function buildVendorTable(vendors){
  let rows = vendors.map(v=>`<tr><td>${escapeHtml(v.id)}</td><td>${escapeHtml(v.name)}</td><td>${escapeHtml(v.email)}</td><td>${escapeHtml(v.type)}</td></tr>`).join("");
  return `<tr><th>ID</th><th>Name</th><th>Email</th><th>Type</th></tr>${rows}`;
}

function buildResponsesTable(responses){
  let rows = responses.map(r=>`
    <tr>
      <td>${escapeHtml(r.vendor_name)}</td>
      <td>${escapeHtml(r.control_name)}</td>
      <td>${escapeHtml(r.question)}</td>
      <td>${escapeHtml(r.remark||"-")}</td>
      <td>${r.evidence_name ? `<i class="bi bi-paperclip"></i> ${escapeHtml(r.evidence_name)}` : "-"}</td>
      <td>${r.approved? "<span class='badge bg-success'>Approved</span>" : `<button class="btn btn-sm btn-primary" onclick="approve(${r.id})"><i class='bi bi-check2'></i> Approve</button>`}</td>
    </tr>
  `).join("");
  return `<tr><th>Vendor</th><th>Control</th><th>Question</th><th>Remark</th><th>Evidence</th><th>Action</th></tr>${rows}`;
}

// XSS escape
function escapeHtml(text){ const div=document.createElement('div'); div.textContent=text; return div.innerHTML; }

async function approve(id){
  try{ await apiCall(`${API}/responses/${id}/approve`, {method:"PUT"}); loadAdmin(); }
  catch(e){ alert("Approval failed"); }
}

// VENDOR
async function loadVendor(){
  try{
    document.body.classList.add("loading");
    document.getElementById("vendorSection").classList.remove("hidden");
    let res = await apiCall(`${API}/questions`);
    let questions = await res.json();

    let html = questions.map((q,i)=>`
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading${i}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${i}">
            ${escapeHtml(q.control_name)} - ${escapeHtml(q.question)}
          </button>
        </h2>
        <div id="collapse${i}" class="accordion-collapse collapse" data-bs-parent="#questionsContainer">
          <div class="accordion-body">
            <textarea id="remark-${q.id}" class="form-control mb-2" placeholder="Your Answer"></textarea>
            <input type="file" id="file-${q.id}" class="form-control mb-2" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"/>
            <button class="btn btn-success" onclick="submitResponse(${q.id})"><i class="bi bi-upload"></i> Submit</button>
            <span id="status-${q.id}" class="badge bg-secondary ms-2" style="display:none;">Submitted</span>
          </div>
        </div>
      </div>
    `).join("");
    document.getElementById("questionsContainer").innerHTML = html;
  } catch(e){ alert("Failed to load questions"); }
  finally{ document.body.classList.remove("loading"); }
}

async function submitResponse(qid){
  try{
    const remark = document.getElementById(`remark-${qid}`).value;
    const file = document.getElementById(`file-${qid}`).files[0];
    const form = new FormData();
    form.append("question_id", qid);
    form.append("remark", remark);
    if(file) form.append("evidence", file);

    const res = await apiCall(`${API}/responses`, {method:"POST", body:form});
    if(res.ok){
      document.getElementById(`status-${qid}`).textContent="Submitted";
      document.getElementById(`status-${qid}`).className="badge bg-success ms-2";
      document.getElementById(`status-${qid}`).style.display="inline";
      alert("Submitted successfully!");
    } else {
      const data = await res.json();
      alert(data.error || "Failed");
    }
  } catch(e){ alert("Submission failed: " + e.message); }
}
</script>

<style>
.hidden { display:none; }
body.loading { opacity:0.6; pointer-events:none; }
body.loading::after{
  content:"Loading..."; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:rgba(0,0,0,0.8); color:white; padding:20px; border-radius:10px; z-index:9999;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
