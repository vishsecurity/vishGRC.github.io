<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRC TPRM Admin Dashboard</title>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
<style>
  body { padding: 20px; }
  .question-card { margin-bottom: 20px; }
</style>
</head>
<body>

<h3>GRC TPRM Dashboard</h3>

<div class="input-field col s12">
  <select id="domainFilter">
    <option value="" selected>All Domains</option>
  </select>
  <label>Filter by Domain</label>
</div>

<div id="questionsContainer"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  M.AutoInit();

  let questions = [];

  async function fetchQuestions(domain='') {
    try {
      const res = await fetch('http://localhost:3000/questions');
      const data = await res.json();
      questions = domain ? data.filter(q => q.domain === domain) : data;
      renderQuestions();
      populateDomains(data);
    } catch(err) {
      console.error(err);
    }
  }

  function populateDomains(data) {
    const select = document.getElementById('domainFilter');
    const domains = [...new Set(data.map(q => q.domain))];
    select.innerHTML = '<option value="" selected>All Domains</option>';
    domains.forEach(d => {
      const opt = document.createElement('option');
      opt.value = d; opt.text = d;
      select.appendChild(opt);
    });
    M.FormSelect.init(select);
  }

  document.getElementById('domainFilter').addEventListener('change', e => {
    fetchQuestions(e.target.value);
  });

  function renderQuestions() {
    const container = document.getElementById('questionsContainer');
    container.innerHTML = '';
    questions.forEach(q => {
      const card = document.createElement('div');
      card.className = 'card question-card';
      card.innerHTML = `
        <div class="card-content">
          <span class="card-title">${q.question}</span>
          <p><b>Domain:</b> ${q.domain}</p>
          <p><b>Reference:</b> ${q.reference || '-'}</p>
          <form id="form-${q.id}" enctype="multipart/form-data">
            <div class="file-field input-field">
              <div class="btn">
                <span>Evidence</span>
                <input type="file" name="evidence" accept=".pdf,.doc,.docx,.ppt,.pptx,.xlsx,.xls,.png,.jpeg,.jpg">
              </div>
              <div class="file-path-wrapper">
                <input class="file-path validate" type="text">
              </div>
            </div>
            <div class="input-field">
              <input type="text" name="remark" placeholder="Remark">
            </div>
            <button class="btn waves-effect waves-light" type="submit">Submit</button>
            <button class="btn red waves-effect waves-light" type="button" id="delete-${q.id}">Delete</button>
            <span id="msg-${q.id}"></span>
          </form>
        </div>`;
      container.appendChild(card);

      const form = document.getElementById(`form-${q.id}`);
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const data = new FormData(form);
        data.append('question_id', q.id);
        try {
          const res = await fetch('http://localhost:3000/responses', { method: 'POST', body: data });
          const result = await res.json();
          if(res.ok) document.getElementById(`msg-${q.id}`).innerText = 'Submitted successfully!';
          else document.getElementById(`msg-${q.id}`).innerText = 'Failed: ' + result.error;
        } catch(err) {
          console.error(err);
          document.getElementById(`msg-${q.id}`).innerText = 'Failed to submit';
        }
      });

      document.getElementById(`delete-${q.id}`).addEventListener('click', async () => {
        if(!confirm('Are you sure to delete?')) return;
        try {
          const res = await fetch(`http://localhost:3000/questions/${q.id}`, { method: 'DELETE' });
          if(res.ok) fetchQuestions();
        } catch(err) { console.error(err); }
      });
    });
  }

  fetchQuestions();
});
</script>
</body>
</html>
